# 库存管理后端接口测试开发计划

## 任务概述

完成 `day8-plan.md` 任务 4.1 后端接口测试，为库存管理模块创建完整的测试套件。

## 执行步骤

### 步骤 1：分析与设计

#### 1.1 引用规范条款
1. **测试规范-第1条**（测试覆盖范围：必须测试字段映射、类型转换、批量操作）
2. **控制层规范-第4.1条**（批量操作接口规范）
3. **控制层规范-第4.2条**（异常处理规范）

#### 1.2 设计测试用例

| 测试编号 | 测试名称 | 测试场景 | 预期结果 |
|---------|---------|---------|---------|
| 1 | 库存列表查询接口测试（5个测试用例） | 正常查询、空结果、分页、排序、筛选 | HTTP 200，业务码 200 |
| 2 | 库存预警接口测试（4个测试用例） | 低库存列表、超储列表、全部预警、临期列表 | HTTP 200，业务码 200 |
| 3 | 库存调整接口测试（3个测试用例） | 正常调整、负数调整、库存不足 | HTTP 200，业务码 200/500 |
| 4 | 库存统计接口测试（3个测试用例） | 库存价值、库存周转率、库存统计 | HTTP 200，业务码 200 |
| 5 | 边界条件测试（4个测试用例） | 超大页码、负数页码、空参数、无效状态 | HTTP 200/400 |
| 6 | 异常处理测试（3个测试用例） | 库存不存在、库存不足、库存超储 | HTTP 200，业务码 404/500 |

#### 1.3 数据库变更设计

无需数据库表结构变更，使用 H2 内存数据库进行测试。

### 步骤 2：实现与编码

#### 2.1 创建测试环境配置

创建 `backend/src/test/resources/application-test.yml`：
```yaml
spring:
  datasource:
    url: jdbc:h2:mem:testdb;MODE=MySQL;DB_CLOSE_DELAY=-1
    driver-class-name: org.h2.Driver
    username: sa
    password:
  h2:
    console:
      enabled: true
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
```

#### 2.2 创建测试类

创建 `backend/src/test/java/com/haocai/management/controller/MaterialInventoryControllerTest.java`：

**测试类结构**：
```java
@SpringBootTest
@AutoConfigureMockMvc
@ActiveProfiles("test")
public class MaterialInventoryControllerTest {
    @Autowired
    private MockMvc mockMvc;
    
    @Autowired
    private ObjectMapper objectMapper;
    
    @MockBean
    private IMaterialInventoryService inventoryService;
    
    // 测试数据
    private MaterialInventory testInventory;
    private InventoryQueryDTO queryDTO;
    private InventoryUpdateDTO updateDTO;
    private InventoryAdjustDTO adjustDTO;
}
```

#### 2.3 实现测试用例

**库存列表查询接口测试（5个测试用例）**：
- testGetInventoryPage_Success：正常分页查询
- testGetInventoryPage_EmptyResult：空结果查询
- testGetInventoryPage_WithFilters：带筛选条件查询
- testGetInventoryPage_WithSorting：带排序查询
- testGetInventoryPage_WithPagination：分页参数验证

**库存预警接口测试（4个测试用例）**：
- testGetInventoryWarning_Success：获取全部预警
- testGetLowStockList_Success：获取低库存列表
- testGetOverStockList_Success：获取超储列表
- testGetExpiredList_Success：获取临期列表

**库存调整接口测试（3个测试用例）**：
- testAdjustInventory_Success：正常调整（正数）
- testAdjustInventory_NegativeQuantity：负数调整（减少库存）
- testAdjustInventory_InsufficientStock：库存不足异常

**库存统计接口测试（3个测试用例）**：
- testGetInventoryStatistics_Success：获取库存统计
- testGetInventoryValue_Success：获取库存价值
- testGetInventoryTurnover_Success：获取库存周转率

**边界条件测试（4个测试用例）**：
- testGetInventoryPage_LargePageNumber：超大页码
- testGetInventoryPage_NegativePageNumber：负数页码
- testGetInventoryPage_EmptyParameters：空参数
- testGetInventoryPage_InvalidStatus：无效库存状态

**异常处理测试（3个测试用例）**：
- testGetInventoryById_NotFound：库存不存在
- testAdjustInventory_InsufficientStock：库存不足
- testUpdateInventory_NotFound：更新不存在的库存

### 步骤 3：验证与测试

#### 3.1 静态检查
- 检查前后端字段一致性
- 检查接口数据契约匹配
- 检查 DTO 和 VO 类型定义

#### 3.2 动态测试
- 运行 Maven 测试命令
- 验证所有测试用例通过
- 生成测试覆盖率报告

#### 3.3 调试顺序
若出现错误，严格按照 **数据库 -> 后端 -> 前端 -> 测试文件** 的顺序排查并修复

### 步骤 4：总结与固化

#### 4.1 创建开发记录文档

创建 `docs/day8/inventory-backend-test-development-report.md`，包含：
- 任务完成状态
- 开发过程记录
- 代码与文档清单
- 规范遵循摘要
- 后续步骤建议

#### 4.2 更新 day8-plan.md

标记任务 4.1 的所有子任务为已完成

## 遵循的规范条款

1. **测试规范-第1条**（测试覆盖范围：必须测试字段映射、类型转换、批量操作）
2. **控制层规范-第4.1条**（批量操作接口规范）
3. **控制层规范-第4.2条**（异常处理规范）

## 预期交付物

1. `backend/src/test/resources/application-test.yml` - 测试环境配置
2. `backend/src/test/java/com/haocai/management/controller/MaterialInventoryControllerTest.java` - 测试类
3. `docs/day8/inventory-backend-test-development-report.md` - 开发记录文档
4. 更新 `docs/day8/day8-plan.md` - 标记任务 4.1 为已完成