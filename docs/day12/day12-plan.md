# 第十二天工作计划：出库管理模块开发（下）

## 日期：2026年1月17日

## 总体目标
完成出库管理模块下半部分的开发，实现出库执行、归还管理等核心功能，建立完整的出库执行和归还流程，为库存管理提供数据支持。

## 详细工作任务

### 1. 后端出库执行功能开发（预计2.5小时）

#### 1.1 出库执行实体类和DTO设计（预计0.5小时）
- [ ] 创建出库执行DTO类
  - `OutboundExecuteDTO`：出库执行请求
    - 出库单ID（必填）
    - 执行人ID（必填）
    - 执行时间（必填）
    - 执行备注（可选）
    - 扫码确认标志（可选）
  - `OutboundExecuteVO`：出库执行响应
    - 出库单基本信息
    - 出库明细列表
    - 库存扣减详情
    - 执行结果状态
- [ ] 配置DTO验证注解
  - 出库单ID非空验证
  - 执行人ID非空验证
  - 执行时间非空验证
- [ ] 创建开发文档

#### 1.2 出库执行Service层开发（预计1.5小时）
- [ ] 扩展`IOutboundOrderService`接口
  ```java
  - executeOutbound(OutboundExecuteDTO dto) - 执行出库
  - getPendingOutboundList() - 获取待出库列表
  - validateOutboundStock(Long orderId) - 验证库存充足性
  - deductInventory(Long orderId) - 扣减库存
  - updateOutboundStatus(Long orderId, OutboundStatus status) - 更新出库状态
  ```
- [ ] 实现`OutboundOrderServiceImpl`新方法
  - 实现出库执行逻辑
    - 验证出库单状态（必须是已批准状态）
    - 验证库存充足性
    - 使用Redis分布式锁防止并发出库
    - 扣减库存数量
    - 更新可用库存
    - 更新出库单状态为已出库
    - 记录出库时间
    - 记录出库日志
  - 实现库存扣减逻辑
    - 遍历出库明细
    - 扣减对应耗材的库存数量
    - 扣减可用库存数量
    - 更新最后出库时间
    - 累加累计出库数量
  - 实现库存验证逻辑
    - 检查库存数量是否充足
    - 检查可用库存是否充足
    - 库存不足时抛出业务异常
  - 添加事务控制
    - 出库执行和库存扣减在同一事务中
    - 异常时自动回滚
  - 添加详细日志记录
    - 记录出库执行开始
    - 记录库存扣减详情
    - 记录出库执行结果
- [ ] 创建开发文档

#### 1.3 出库执行Controller层开发（预计0.5小时）
- [ ] 扩展`OutboundOrderController`
  ```java
  POST   /api/outbound/execute              - 执行出库
  GET    /api/outbound/pending              - 获取待出库列表
  GET    /api/outbound/{id}/stock-validate  - 验证库存充足性
  ```
- [ ] 添加接口文档注解
  - 使用@Operation注解完善接口说明
  - 添加参数说明
  - 添加返回值示例
- [ ] 添加权限控制注解
  - 使用@PreAuthorize控制接口访问权限
  - 例如：@PreAuthorize("hasAuthority('outbound:execute')")
- [ ] 创建开发文档

### 2. 后端归还管理功能开发（预计2.5小时）

#### 2.1 归还管理实体类和DTO设计（预计0.5小时）
- [ ] 创建归还记录实体类`ReturnRecord`
  - 归还记录ID（主键）
  - 出库明细ID（外键）
  - 归还日期（必填）
  - 归还数量（必填）
  - 归还状态（必填：完好/损坏/丢失）
  - 损坏描述（可选）
  - 处理人ID（必填）
  - 备注信息（可选）
  - 创建时间、更新时间
  - 使用Lombok注解简化代码
  - 配置JPA注解和表映射
- [ ] 创建归还管理DTO类
  - `ReturnRecordCreateDTO`：归还记录创建请求
    - 出库明细ID（必填）
    - 归还数量（必填）
    - 归还状态（必填）
    - 损坏描述（可选）
    - 处理人ID（必填）
    - 备注信息（可选）
  - `ReturnRecordUpdateDTO`：归还记录更新请求
    - 归还记录ID（必填）
    - 归还数量（可选）
    - 归还状态（可选）
    - 损坏描述（可选）
    - 备注信息（可选）
  - `ReturnRecordVO`：归还记录响应
    - 归还记录基本信息
    - 出库明细信息
    - 耗材信息
    - 处理人信息
- [ ] 创建归还状态枚举类`ReturnStatus`
  - 定义归还状态枚举（完好、损坏、丢失）
  - 提供状态转换方法
  - 提供状态描述方法
- [ ] 配置DTO验证注解
  - 出库明细ID非空验证
  - 归还数量非空验证
  - 归还状态非空验证
  - 处理人ID非空验证
  - 归还数量范围验证（大于0，小于等于应还数量）
- [ ] 创建开发文档

#### 2.2 归还管理Mapper层开发（预计0.5小时）
- [ ] 创建归还记录Mapper接口`ReturnRecordMapper`
  - 继承BaseMapper获得基础CRUD方法
  - 自定义查询方法：
    - 根据出库明细ID查询归还记录
    - 根据归还日期查询归还记录
    - 根据归还状态查询归还记录
    - 分页查询归还记录
    - 统计归还数量
  - 配置MyBatis-Plus注解
- [ ] 创建开发文档

#### 2.3 归还管理Service层开发（预计1小时）
- [ ] 创建归还管理Service接口`IReturnRecordService`
  ```java
  - createReturnRecord(ReturnRecordCreateDTO dto) - 创建归还记录
  - updateReturnRecord(ReturnRecordUpdateDTO dto) - 更新归还记录
  - deleteReturnRecord(Long id) - 删除归还记录
  - getReturnRecordById(Long id) - 根据ID查询归还记录
  - getReturnRecordList(PageParam pageParam) - 分页查询归还记录列表
  - getPendingReturnList() - 获取待归还列表
  - getOverdueReturnList() - 获取逾期未归还列表
  - processReturn(ReturnRecordCreateDTO dto) - 处理归还（库存回增）
  - calculateReturnAmount(Long outboundDetailId) - 计算应还数量
  ```
- [ ] 创建归还管理Service实现类`ReturnRecordServiceImpl`
  - 实现归还记录CRUD基本功能
  - 实现归还处理逻辑
    - 验证出库明细是否存在
    - 验证归还数量是否合理
    - 验证归还状态是否有效
    - 根据归还状态处理库存
      - 完好：库存回增
      - 损坏：库存不回增，记录损坏信息
      - 丢失：库存不回增，记录丢失信息
    - 更新出库明细的归还状态
    - 更新出库明细的已归还数量
    - 检查是否全部归还，更新出库单状态
  - 实现库存回增逻辑
    - 遍历归还记录
    - 增加对应耗材的库存数量
    - 增加可用库存数量
    - 更新最后入库时间
  - 实现逾期查询逻辑
    - 查询预计归还日期小于当前日期的出库单
    - 查询未归还的出库明细
  - 添加业务异常处理
  - 添加事务控制
  - 添加详细日志记录
- [ ] 创建开发文档

#### 2.4 归还管理Controller层开发（预计0.5小时）
- [ ] 创建归还管理Controller`ReturnRecordController`
  ```java
  @RestController
  @RequestMapping("/api/return")
  @Tag(name = "归还管理", description = "归还管理接口")
  ```
- [ ] 实现以下API接口：
  ```java
  POST   /api/return                    - 创建归还记录
  PUT    /api/return/{id}               - 更新归还记录
  DELETE /api/return/{id}               - 删除归还记录
  GET    /api/return/{id}               - 获取归还记录详情
  GET    /api/return/list               - 分页查询归还记录列表
  GET    /api/return/pending            - 获取待归还列表
  GET    /api/return/overdue            - 获取逾期未归还列表
  POST   /api/return/process            - 处理归还
  GET    /api/return/calculate/{id}     - 计算应还数量
  ```
- [ ] 添加接口文档注解
  - 使用@Tag、@Operation、@Parameter等注解
  - 完善接口说明文档
- [ ] 添加权限控制注解
  - 使用@PreAuthorize控制接口访问权限
  - 例如：@PreAuthorize("hasAuthority('return:create')")
- [ ] 创建开发文档

### 3. 数据库表结构完善（预计1小时）

#### 3.1 归还记录表结构
- [ ] 检查并完善归还记录表`return_record`
  - 确认所有字段定义正确
  - 检查索引配置
  - 验证外键约束
  - 添加归还状态索引
  - 添加归还日期索引
  - 添加出库明细ID索引
- [ ] 更新出库明细表`outbound_detail`
  - 添加归还状态字段
  - 添加已归还数量字段
  - 添加归还时间字段
  - 添加相关索引
- [ ] 执行数据库脚本更新
  - 更新init.sql脚本
  - 执行数据库迁移
- [ ] 创建开发文档

### 4. 前端出库执行页面开发（预计1.5小时）

#### 4.1 出库执行列表页面（预计1小时）
- [ ] 创建出库执行页面组件`OutboundExecute.vue`
  - 待出库列表表格（支持分页）
  - 出库单基本信息展示
  - 出库明细列表展示
  - 库存充足性提示
  - 执行出库按钮
  - 扫码确认功能（可选）
  - 执行备注输入框
- [ ] 配置出库执行路由
  - 添加到路由配置中
  - 配置页面权限
- [ ] 实现出库执行逻辑
  - 调用后端执行出库接口
  - 验证库存充足性
  - 执行成功后刷新列表
  - 执行失败显示错误提示
- [ ] 创建开发文档

#### 4.2 出库执行详情页面（预计0.5小时）
- [ ] 创建出库执行详情页面组件`OutboundExecuteDetail.vue`
  - 出库单详细信息展示
  - 出库明细详细信息展示
  - 库存扣减详情展示
  - 执行结果状态展示
  - 执行日志展示
- [ ] 配置出库执行详情路由
  - 添加到路由配置中
  - 配置页面权限
- [ ] 创建开发文档

### 5. 前端归还管理页面开发（预计1.5小时）

#### 5.1 归还管理列表页面（预计1小时）
- [ ] 创建归还管理页面组件`ReturnManage.vue`
  - 归还记录列表表格（支持分页）
  - 搜索功能（按归还日期、归还状态、出库单号搜索）
  - 待归还列表（单独标签页）
  - 逾期未归还列表（单独标签页）
  - 归还登记弹窗表单
  - 归还详情查看
- [ ] 配置归还管理路由
  - 添加到路由配置中
  - 配置页面权限
- [ ] 实现归还管理API调用
  - 获取归还记录列表
  - 获取待归还列表
  - 获取逾期未归还列表
  - 创建归还记录
  - 更新归还记录
  - 删除归还记录
  - 计算应还数量
- [ ] 创建开发文档

#### 5.2 归还登记弹窗（预计0.5小时）
- [ ] 创建归还登记弹窗组件`ReturnRegisterDialog.vue`
  - 出库明细信息展示
  - 应还数量显示
  - 归还数量输入框
  - 归还状态选择（完好/损坏/丢失）
  - 损坏描述输入框（损坏时显示）
  - 备注信息输入框
  - 表单验证
  - 提交按钮
- [ ] 实现归还登记逻辑
  - 调用后端处理归还接口
  - 归还成功后刷新列表
  - 归还失败显示错误提示
- [ ] 创建开发文档

### 6. 功能测试和联调（预计1.5小时）

#### 6.1 后端接口测试
- [ ] 创建测试类`OutboundExecuteServiceTest`
  - 出库执行功能测试
  - 库存扣减准确性测试
  - 并发出库测试
  - 库存不足异常测试
  - 事务回滚测试
- [ ] 创建测试类`ReturnRecordServiceTest`
  - 归还记录CRUD功能测试
  - 归还处理功能测试
  - 库存回增准确性测试
  - 逾期查询功能测试
  - 应还数量计算测试
- [ ] 创建测试类`OutboundExecuteControllerTest`
  - 出库执行接口测试
  - 待出库列表接口测试
  - 库存验证接口测试
- [ ] 创建测试类`ReturnRecordControllerTest`
  - 归还记录接口测试
  - 待归还列表接口测试
  - 逾期列表接口测试
  - 处理归还接口测试
- [ ] 执行测试并验证结果
- [ ] 生成测试覆盖率报告
- [ ] 创建开发文档

#### 6.2 前端功能测试
- [ ] 出库执行页面功能测试
  - 待出库列表显示测试
  - 出库执行功能测试
  - 库存验证功能测试
  - 扫码确认功能测试（如实现）
- [ ] 归还管理页面功能测试
  - 归还记录列表显示测试
  - 待归还列表显示测试
  - 逾期列表显示测试
  - 归还登记功能测试
  - 归还详情查看测试
- [ ] 创建开发文档

#### 6.3 前后端联调测试
- [ ] 出库执行流程完整测试
  - 创建出库单
  - 审批通过
  - 执行出库
  - 验证库存扣减
- [ ] 归还管理流程完整测试
  - 查看待归还列表
  - 登记归还（完好）
  - 验证库存回增
  - 登记归还（损坏）
  - 验证库存不回增
  - 登记归还（丢失）
  - 验证库存不回增
- [ ] 逾期提醒功能测试
  - 查询逾期未归还列表
  - 验证逾期计算准确性
- [ ] 并发操作测试
  - 并发出库测试
  - 并发归还测试
- [ ] 异常处理测试
  - 库存不足异常测试
  - 归还数量异常测试
  - 网络异常测试
- [ ] 创建开发文档

## 验收标准
- [ ] 出库执行功能正常，库存扣减准确
- [ ] 归还管理功能完整，库存回增正确
- [ ] 待归还列表显示正确
- [ ] 逾期未归还列表显示正确
- [ ] 归还状态处理正确（完好/损坏/丢失）
- [ ] 并发出库和归还操作安全
- [ ] 所有接口都有相应权限控制
- [ ] 前后端联调测试通过
- [ ] 测试覆盖率 > 80%

## 技术要点
- Redis分布式锁防止并发出库
- 事务控制保证数据一致性
- 库存扣减和回增逻辑
- 归还状态处理逻辑
- 逾期计算逻辑
- 应还数量计算逻辑
- Vue 3 Composition API
- Element Plus组件库
- TypeScript类型安全
- 前端表单验证
- 前端状态管理

## 注意事项
- 出库执行前必须验证库存充足性
- 使用Redis分布式锁防止并发出库
- 归还完好时需要回增库存
- 归还损坏或丢失时不回增库存
- 归还数量不能超过应还数量
- 逾期计算需要考虑预计归还日期
- 所有操作需要记录详细日志
- 前端需要处理各种异常情况
- 前端需要提供友好的错误提示

## 预计完成时间
18:00 - 出库管理模块下半部分开发完成并测试通过

## 风险评估
- 并发出库可能导致库存数据不一致
- 归还状态处理逻辑复杂，容易出错
- 逾期计算逻辑需要准确
- 库存回增逻辑需要准确
- 前端表单验证需要完善
- 异常处理需要全面

## 依赖检查
- 确保出库单表结构正确
- 确保出库明细表结构正确
- 确保库存表结构正确
- 确保Redis配置正确
- 确保前端路由配置正确
- 确保前端API调用正确

## 开发流程规范
1. **开发前准备**
   - 阅读相关文档和代码
   - 理解业务逻辑和技术要点
   - 准备测试数据

2. **开发过程**
   - 按照任务清单逐步开发
   - 每完成一个功能立即测试
   - 遇到问题及时记录和解决
   - 代码提交前务必测试通过

3. **测试要求**
   - 本地测试：所有功能在本地进行完整测试
   - 自动化测试：编写自动化测试脚本
   - 推送前验证：确保本地测试全部通过
   - 部署测试：代码推送后触发CI流程

4. **文档要求**
   - 开发记录：记录实现思路、关键代码变更、依赖调整
   - 测试记录：记录测试工具、测试方法、测试结果
   - 文档更新：同步更新技术文档、API文档

5. **质量要求**
   - 代码审查：所有合并请求需经过审查
   - 测试覆盖率：单元测试覆盖率 > 80%
   - 性能要求：接口响应时间 < 2秒

## 相关文档
- docs/common/plan.md - 系统整体规划
- docs/day11/day11-plan.md - 出库管理模块开发（上）
- docs/day10/day10-plan.md - 入库管理模块开发
- docs/day8/day8-plan.md - 库存管理基础功能
