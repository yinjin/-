# 第三天工作计划：基础管理模块开发 - 角色权限管理

## 日期：2026年1月8日

## 总体目标
完成角色权限管理模块的开发，实现基于RBAC模型的权限控制系统，为系统提供细粒度的权限管理能力。

## 详细工作任务

### 1. 后端角色权限管理模块开发（预计5小时）

#### 1.1 角色权限实体类设计（预计1小时）✅ 已完成
- [x] 创建角色实体类 `SysRole`
  - 角色基本信息字段：id、roleName、roleCode、description
  - 角色状态字段：status（正常/禁用）、createTime、updateTime
  - 使用Lombok注解简化代码
  - 配置JPA注解和表映射
- [x] 创建权限实体类 `SysPermission`
  - 权限基本信息字段：id、permissionName、permissionCode、resourceType
  - 权限层级字段：parentId、level、sortOrder
  - 权限路由字段：path、component、icon
  - 权限状态字段：status、createTime、updateTime
- [x] 创建角色权限关联实体类 `SysRolePermission`
  - 关联字段：id、roleId、permissionId
  - 创建时间字段：createTime
  - 配置唯一约束（roleId + permissionId）
- [x] 创建用户角色关联实体类 `SysUserRole`
  - 关联字段：id、userId、roleId
  - 创建时间字段：createTime
  - 配置唯一约束（userId + roleId）
- [x] 创建角色DTO类
  - `RoleCreateDTO`：角色创建请求
  - `RoleUpdateDTO`：角色更新请求
  - `RoleVO`：角色信息响应
- [x] 创建权限DTO类
  - `PermissionCreateDTO`：权限创建请求
  - `PermissionUpdateDTO`：权限更新请求
  - `PermissionVO`：权限信息响应（包含子权限列表）
- [x] 配置实体类验证注解
  - 角色名称、编码长度验证
  - 权限名称、编码唯一性验证
- [x] 编译测试通过
- [x] 创建开发教程文档

#### 1.2 角色权限数据访问层（预计1小时）✅ 已完成
- [x] 创建角色Mapper接口 `SysRoleMapper`
  - 继承BaseMapper获得基础CRUD方法
  - 自定义查询方法：根据角色编码查询、根据状态查询、分页查询
  - 配置MyBatis-Plus注解
- [x] 创建权限Mapper接口 `SysPermissionMapper`
  - 继承BaseMapper获得基础CRUD方法
  - 自定义查询方法：根据权限编码查询、根据父权限查询、树形结构查询
  - 配置MyBatis-Plus注解
- [x] 创建角色权限关联Mapper接口 `SysRolePermissionMapper`
  - 继承BaseMapper获得基础CRUD方法
  - 自定义查询方法：根据角色ID查询权限列表、根据权限ID查询角色列表
- [x] 创建用户角色关联Mapper接口 `SysUserRoleMapper`
  - 继承BaseMapper获得基础CRUD方法
  - 自定义查询方法：根据用户ID查询角色列表、根据角色ID查询用户列表
- [x] 配置数据访问层异常处理
  - 角色编码重复异常
  - 权限编码重复异常
  - 关联数据删除异常
- [x] 编译测试通过
- [x] 创建开发教程文档

#### 1.3 角色权限业务逻辑层（预计2小时）✅ 已完成
- [x] 创建角色Service接口 `ISysRoleService`
  - 定义角色CRUD业务方法接口
  - 定义角色权限分配方法接口
  - 定义角色权限查询方法接口
- [x] 创建角色Service实现类 `SysRoleServiceImpl`
  - 角色创建逻辑（角色编码唯一性检查）
  - 角色更新逻辑（角色存在性检查）
  - 角色删除逻辑（检查是否有关联用户）
  - 角色权限分配逻辑（先删除旧权限，再插入新权限）
  - 角色权限查询逻辑（查询角色拥有的所有权限）
  - 添加业务异常处理
  - 添加事务控制
- [x] 创建权限Service接口 `ISysPermissionService`
  - 定义权限CRUD业务方法接口
  - 定义权限树形结构查询方法接口
  - 定义根据角色查询权限方法接口
- [x] 创建权限Service实现类 `SysPermissionServiceImpl`
  - 权限创建逻辑（权限编码唯一性检查、父权限存在性检查）
  - 权限更新逻辑（权限存在性检查）
  - 权限删除逻辑（检查是否有子权限、检查是否有角色关联）
  - 权限树形结构构建逻辑（递归构建）
  - 根据角色查询权限逻辑（查询角色拥有的所有权限）
  - 添加业务异常处理
  - 添加事务控制
- [x] 创建用户角色Service接口扩展
  - `assignRoles(Long userId, List<Long> roleIds)` - 分配角色
  - `getUserRoles(Long userId)` - 获取用户角色
  - `getUserPermissions(Long userId)` - 获取用户权限
- [x] 实现用户角色Service方法
  - 角色分配逻辑（先删除旧角色，再插入新角色）
  - 用户角色查询逻辑
  - 用户权限查询逻辑（合并所有角色的权限，去重）
- [x] 编译测试通过
- [x] 创建开发教程文档

#### 1.4 角色权限控制层（预计1小时）
- [ ] 创建角色Controller `SysRoleController`
  - `POST /api/role` - 创建角色
  - `PUT /api/role/{id}` - 更新角色
  - `DELETE /api/role/{id}` - 删除角色
  - `GET /api/role/{id}` - 获取角色详情
  - `GET /api/role/list` - 分页查询角色列表
  - `PUT /api/role/{id}/permissions` - 更新角色权限
  - `GET /api/role/{id}/permissions` - 获取角色权限
- [ ] 创建权限Controller `SysPermissionController`
  - `POST /api/permission` - 创建权限
  - `PUT /api/permission/{id}` - 更新权限
  - `DELETE /api/permission/{id}` - 删除权限
  - `GET /api/permission/{id}` - 获取权限详情
  - `GET /api/permission/tree` - 获取权限树形结构
  - `GET /api/permission/list` - 分页查询权限列表
- [ ] 创建自定义权限注解 `@RequirePermission`
  - 定义注解属性：value（权限编码数组）、logical（AND/OR逻辑）
  - 配置注解作用域：METHOD、TYPE
  - 配置注解保留策略：RUNTIME
- [ ] 创建权限切面 `PermissionAspect`
  - 实现权限检查逻辑
  - 从JWT Token或Redis获取用户权限
  - 验证用户是否有访问权限
  - 权限不足时抛出异常
- [ ] 修改SecurityConfig
  - 配置方法级安全控制
  - 启用@PreAuthorize注解
  - 配置自定义权限评估器
- [ ] 集成Swagger API文档
- [ ] 参数验证和异常处理
- [ ] 编译测试通过

### 2. 数据库表结构完善（预计1小时）

#### 2.1 角色权限相关表结构
- [ ] 检查并完善角色表 `sys_role`
  - 确认所有字段定义正确
  - 检查索引配置
  - 验证唯一约束
- [ ] 检查并完善权限表 `sys_permission`
  - 确认所有字段定义正确
  - 检查索引配置
  - 验证唯一约束
- [ ] 检查并完善角色权限关联表 `sys_role_permission`
  - 确认关联字段定义正确
  - 检查唯一约束
  - 验证外键约束
- [ ] 检查并完善用户角色关联表 `sys_user_role`
  - 确认关联字段定义正确
  - 检查唯一约束
  - 验证外键约束
- [ ] 执行数据库脚本更新
  - 更新init.sql脚本
  - 执行数据库迁移
- [ ] 创建初始化角色权限数据脚本
  - 创建初始化角色（超级管理员、教师、学生、仓库管理员）
  - 创建初始化权限（按模块划分）
  - 创建角色权限关联
- [ ] 创建开发文档

### 3. 前端角色权限管理页面开发（预计3小时）

#### 3.1 角色管理页面开发（预计1.5小时）
- [ ] 创建角色管理页面 `RoleManage.vue`
  - 角色列表表格（支持分页）
  - 搜索功能（按角色名称、编码、状态搜索）
  - 新增角色弹窗表单
  - 编辑角色弹窗表单
  - 删除角色确认对话框
  - 角色状态切换功能
  - 分配权限弹窗（树形权限选择）
- [ ] 配置角色管理路由
  - 添加到路由配置中
  - 配置页面权限
- [ ] 实现角色管理API调用
  - 获取角色列表
  - 新增角色
  - 更新角色
  - 删除角色
  - 切换角色状态
  - 分配权限
  - 获取角色权限

#### 3.2 权限管理页面开发（预计1小时）
- [ ] 创建权限管理页面 `PermissionManage.vue`
  - 权限树形结构展示（支持展开/折叠）
  - 搜索功能（按权限名称、编码搜索）
  - 新增权限弹窗表单（支持选择父权限）
  - 编辑权限弹窗表单
  - 删除权限确认对话框
  - 权限状态切换功能
- [ ] 配置权限管理路由
  - 添加到路由配置中
  - 配置页面权限
- [ ] 实现权限管理API调用
  - 获取权限树
  - 获取权限列表
  - 新增权限
  - 更新权限
  - 删除权限

#### 3.3 用户管理页面集成角色功能（预计0.5小时）
- [ ] 修改用户管理页面 `UserManage.vue`
  - 用户列表中显示角色信息
  - 新增/编辑用户时添加角色选择（多选下拉框）
  - 添加分配角色功能按钮
- [ ] 实现用户角色API调用
  - 获取用户角色
  - 分配角色

### 4. 功能测试和联调（预计1小时）

#### 4.1 后端接口测试
- [ ] 创建测试类SysRoleServiceTest
  - 角色CRUD功能测试
  - 角色权限分配测试
  - 角色权限查询测试
  - 边界条件测试
- [ ] 创建测试类SysPermissionServiceTest
  - 权限CRUD功能测试
  - 权限树形结构测试
  - 根据角色查询权限测试
  - 边界条件测试
- [ ] 创建测试类SysRoleControllerTest
  - 角色管理API接口测试
  - 权限控制功能测试
- [ ] 创建测试类SysPermissionControllerTest
  - 权限管理API接口测试
  - 权限树接口测试
- [ ] 执行测试并验证结果
- [ ] 生成测试覆盖率报告
- [ ] 集成到CI/CD流程

#### 4.2 前端功能测试
- [ ] 角色管理页面功能测试
- [ ] 权限管理页面功能测试
- [ ] 用户角色分配功能测试
- [ ] 权限控制功能测试

#### 4.3 前后端联调测试
- [ ] 角色管理CRUD测试
- [ ] 权限管理CRUD测试
- [ ] 角色权限分配测试
- [ ] 用户角色分配测试
- [ ] 权限验证测试（有权限、无权限场景）
- [ ] 权限树形结构测试
- [ ] 并发操作测试

## 验收标准
- [ ] 角色管理CRUD功能完整
- [ ] 权限管理CRUD功能完整
- [ ] 角色权限分配功能完整
- [ ] 用户角色分配功能完整
- [ ] 方法级权限控制功能完整
- [ ] 权限树形结构查询功能完整
- [ ] 所有接口都有相应权限控制
- [ ] 前后端联调测试通过
- [ ] 单元测试覆盖率 > 80%
- [ ] API文档完整正确

## 技术要点
- RBAC权限模型（基于角色的访问控制）
- 树形结构递归查询
- 自定义权限注解和切面
- Spring Security方法级权限控制
- MyBatis-Plus多表关联查询
- Vue 3树形组件（Element Plus Tree）
- 权限路由控制

## 注意事项
- 角色编码和权限编码必须唯一
- 删除角色前检查是否有关联用户
- 删除权限前检查是否有子权限和角色关联
- 权限树形结构支持任意层级
- 用户权限需要合并所有角色的权限（去重）
- 权限不足时返回403 Forbidden
- 所有操作添加详细日志记录

## 预计完成时间
18:00 - 角色权限管理模块开发完成并测试通过

## 风险评估
- 权限控制逻辑复杂，容易出现安全漏洞
- 树形结构查询性能可能存在问题
- 权限缓存策略需要合理设计
- 前端权限控制需要与后端保持一致

## 依赖检查
- 确保Spring Security依赖正确配置
- 确保MyBatis-Plus多表关联查询配置正确
- 确保前端Element Plus Tree组件正确配置
- 确保数据库表结构与实体类匹配

## 开发流程规范

### 一、开发模式与流程
1. **采用持续集成（CI）开发模式**，确保代码持续集成、自动化构建与测试。
2. **功能驱动开发**：每个功能模块开发完成后，必须经过充分测试与验证，确保无误后方可进入下一功能开发。
3. **迭代推进**：以功能为单位进行迭代，保证每个模块稳定可用。

### 二、测试策略
1. **本地测试优先**：
   - 所有功能需在本地进行完整测试，包括单元测试、集成测试及界面交互测试。
   - 需使用与CI环境一致的测试工具和依赖版本。
2. **自动化测试**：
   - 针对关键路径与核心功能编写自动化测试脚本。
   - 每次提交前应在本地运行自动化测试套件。
3. **推送前验证**：
   - 确保本地测试全部通过后，才可将代码推送至GitHub。
4. **部署测试**：
   - 代码推送后触发CI流程，执行部署与线上环境测试，确保功能在目标环境中正常运行。

### 三、版本控制与部署
1. **分支管理**：采用功能分支策略，每个新功能在独立分支开发，通过Pull Request合并至主分支。
2. **CI/CD流水线**：
   - 利用GitHub Actions等工具实现自动化测试与部署。
   - 部署成功后需在测试环境进行验证。
3. **回滚机制**：确保发现严重问题时能快速回退至上一稳定版本。

### 四、过程记录与文档
1. **开发记录**：每个功能需记录：
   - 实现思路、关键代码变更、依赖调整。
   - 开发过程中遇到的问题与解决方案。
2. **测试记录**：
   - 测试工具、框架及版本。
   - 测试方法、用例设计、测试数据。
   - 测试结果（通过/失败）、截图或日志摘要。
   - 发现的缺陷及其修复状态。
3. **文档更新**：
   - 同步更新技术文档、API文档及用户手册。
   - 记录配置变更、环境依赖及部署步骤。

### 五、质量与协作要求
1. **代码审查**：所有合并请求需经过至少一名成员审查。
2. **持续反馈**：定期同步开发与测试进展，及时调整计划。
3. **责任到人**：每个功能由开发者主导测试并确保质量，测试记录归档至项目Wiki或指定文档库。

通过以上规范，旨在形成**开发→测试→记录→集成**的闭环流程，确保交付质量，并为后续维护、BUG修复与优化提供完整依据。
