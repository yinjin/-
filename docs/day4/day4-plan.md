# 第四天工作计划：基础管理模块开发 - 部门管理

## 日期：2026年1月8日

## 总体目标
完成部门管理模块的开发，实现部门树形结构管理、部门与用户关联、部门负责人管理等功能，为后续模块提供组织架构支持。

## 详细工作任务

### 1. 后端部门管理模块开发（预计4小时）

#### 1.1 部门实体类设计（预计1小时）
- [ ] 创建部门实体类 `SysDepartment`
  - 部门基本信息字段：id、deptName、deptCode、parentId、level、sortOrder ✅
  - 部门状态字段：status（正常/禁用）、createTime、updateTime ✅
  - 部门关联字段：leaderId（部门负责人）、contactInfo（联系方式） ✅
  - 部门描述字段：description（部门描述） ✅
  - 使用Lombok注解简化代码 ✅
  - 配置MyBatis-Plus注解和表映射 ✅
- [ ] 创建部门DTO类
  - `DepartmentCreateDTO`：部门创建请求 ✅
  - `DepartmentUpdateDTO`：部门更新请求 ✅
  - `DepartmentVO`：部门信息响应 ✅
  - `DepartmentTreeVO`：部门树形结构响应 ✅
- [ ] 配置实体类验证注解
  - 部门名称长度验证 ✅
  - 部门编码唯一性验证 ✅
  - 父部门ID存在性验证 ✅
- [ ] 创建DepartmentStatus枚举类
  - 定义部门状态枚举 ✅
  - 提供状态转换方法 ✅
- [ ] 编译测试通过 ✅
- [ ] 创建开发教程文档

#### 1.2 部门数据访问层（预计1小时）
- [ ] 创建部门Mapper接口 `SysDepartmentMapper`
  - 继承BaseMapper获得基础CRUD方法 ✅
  - 自定义查询方法：根据部门编码查询、根据父部门ID查询子部门、分页查询 ✅
  - 查询部门树形结构方法（递归查询） ✅
  - 查询部门及其所有子部门方法 ✅
  - 配置MyBatis-Plus注解 ✅
- [ ] 创建部门Repository接口 `SysDepartmentRepository`
  - 继承JpaRepository获得JPA方法 ✅
  - 自定义查询方法：根据部门名称查找、根据部门编码查找 ✅
- [ ] 配置数据访问层异常处理
  - 部门不存在异常处理 ✅
  - 部门编码重复异常处理 ✅
  - 部门层级异常处理（不能将部门设置为自己的子部门） ✅
- [ ] 编译测试通过 ✅
- [ ] 创建开发教程文档

#### 1.3 部门业务逻辑层（预计1.5小时）
- [ ] 创建部门Service接口 `ISysDepartmentService`
  - 定义部门创建、更新、删除、查询等业务方法接口 ✅
  - 定义部门树形结构查询方法接口 ✅
  - 定义部门层级管理方法接口 ✅
- [ ] 创建部门Service实现类 `SysDepartmentServiceImpl`
  - 部门创建逻辑（部门编码唯一性检查、父部门存在性检查、层级计算） ✅
  - 部门更新逻辑（字段验证、唯一性检查、层级更新） ✅
  - 部门删除逻辑（检查是否有子部门、检查是否有关联用户） ✅
  - 部门树形结构查询逻辑（递归构建树形结构） ✅
  - 部门层级管理逻辑（移动部门、调整层级） ✅
  - 部门负责人管理逻辑（设置负责人、移除负责人） ✅
  - 部门列表查询逻辑（分页、搜索、筛选） ✅
- [ ] 部门层级计算逻辑
  - 根据父部门ID自动计算部门层级 ✅
  - 支持多级部门层级（最多10级） ✅
- [ ] 部门树形结构构建
  - 递归查询子部门 ✅
  - 构建树形结构数据 ✅
  - 支持懒加载子部门 ✅
- [ ] 部门与用户关联管理
  - 查询部门下的所有用户 ✅
  - 查询用户所属部门 ✅
  - 部门删除时处理用户关联 ✅
- [ ] 编译测试通过 ✅
- [ ] 创建开发教程文档

#### 1.4 部门控制层（预计0.5小时）
- [ ] 创建部门Controller `SysDepartmentController`
  - 部门创建接口 `/api/department` ✅
  - 部门更新接口 `/api/department/{id}` ✅
  - 部门删除接口 `/api/department/{id}` ✅
  - 获取部门详情接口 `/api/department/{id}` ✅
  - 获取部门树形结构接口 `/api/department/tree` ✅
  - 获取部门列表接口 `/api/department/list` ✅
  - 设置部门负责人接口 `/api/department/{id}/leader` ✅
  - 移动部门接口 `/api/department/{id}/move` ✅
  - 批量删除接口 `/api/department/batch/delete` ✅
- [ ] 配置接口权限注解
  - 部门查询接口：`department:query` ✅
  - 部门创建接口：`department:create` ✅
  - 部门更新接口：`department:update` ✅
  - 部门删除接口：`department:delete` ✅
- [ ] 集成Swagger API文档 ✅
- [ ] 参数验证和异常处理 ✅
- [ ] 编译测试通过 ✅

### 2. 数据库表结构完善（预计1小时）

#### 2.1 部门相关表结构
- [ ] 检查并完善部门表 `sys_department`
  - 确认所有字段定义正确 ✅
  - 检查索引配置（dept_code、parent_id、status） ✅
  - 验证外键约束（leader_id关联sys_user） ✅
- [ ] 添加部门与用户关联表（如果需要）
  - 创建关联表 `sys_user_department`（如果采用多对多关系） ✅
  - 或者确认sys_user表中的department_id字段 ✅
- [ ] 执行数据库脚本更新
  - 更新init.sql脚本 ✅
  - 执行数据库迁移 ✅
- [ ] 创建初始化数据
  - 创建初始部门数据（学院、系部、教研室） ✅
  - 创建部门树形结构示例数据 ✅
- [ ] 创建开发文档

### 3. 前端部门管理页面开发（预计3小时）

#### 3.1 部门管理页面开发（预计1.5小时）
- [x] 创建部门管理页面 `DepartmentManage.vue` (2026-01-08完成)
  - 部门树形结构展示（使用Element Plus Tree组件） ✅
  - 部门列表表格（支持分页） ✅
  - 搜索功能（按部门名称、编码搜索） ✅
  - 新增部门弹窗表单 ✅
  - 编辑部门弹窗表单 ✅
  - 删除部门确认对话框 ✅
  - 部门状态切换功能 ✅
  - 部门负责人设置功能 ✅
  - 部门移动功能（拖拽或选择父部门） ✅
- [x] 配置部门管理路由 (2026-01-08完成)
  - 添加到路由配置中 ✅
  - 配置页面权限 ✅
- [x] 实现部门管理API调用 (2026-01-08完成)
  - 获取部门树形结构 ✅
  - 获取部门列表 ✅
  - 新增部门 ✅
  - 更新部门 ✅
  - 删除部门 ✅
  - 设置部门负责人 ✅
  - 移动部门 ✅
- [ ] 创建开发文档

#### 3.2 部门树形组件开发（预计1小时）
- [x] 创建部门树形组件 `DepartmentTree.vue` (集成到DepartmentManage.vue中)
  - 树形结构展示 ✅
  - 节点展开/折叠 ✅
  - 节点选择功能 ✅
  - 节点拖拽功能（移动部门） ✅
  - 节点右键菜单（新增、编辑、删除、移动） ✅
  - 节点图标和状态标识 ✅
- [x] 实现树形组件交互 (集成到DepartmentManage.vue中)
  - 点击节点查看详情 ✅
  - 右键菜单操作 ✅
  - 拖拽移动部门 ✅
  - 懒加载子部门 ✅
- [ ] 创建开发文档

#### 3.3 用户管理页面集成部门功能（预计0.5小时）
- [ ] 更新用户管理页面
  - 用户列表添加部门列 ⏳ 待开发
  - 新增/编辑用户时添加部门选择（树形下拉框） ⏳ 待开发
  - 按部门筛选用户 ⏳ 待开发
- [ ] 实现部门选择组件
  - 创建部门树形选择组件 `DepartmentSelect.vue` ⏳ 待开发
  - 支持单选和多选 ⏳ 待开发
  - 支持搜索部门 ⏳ 待开发
- [ ] 创建开发文档

### 4. 功能测试和联调（预计1小时）

#### 4.1 后端接口测试
- [ ] 创建测试类SysDepartmentControllerTest ⏳ 待开发
- [ ] 创建测试环境配置application-test.yml ⏳ 待开发
- [ ] 配置H2内存数据库 ⏳ 待开发
- [ ] 编写测试用例 ⏳ 待开发
  - [ ] 部门创建接口测试（正常创建、编码重复、父部门不存在）
  - [ ] 部门更新接口测试（正常更新、部门不存在、编码重复）
  - [ ] 部门删除接口测试（正常删除、有子部门、有关联用户）
  - [ ] 部门树形结构查询测试（树形结构正确、层级正确）
  - [ ] 部门负责人设置测试（正常设置、用户不存在）
  - [ ] 部门移动测试（正常移动、移动到子部门、移动到自己）
  - [ ] 批量删除测试（正常删除、部分失败）
  - [ ] 边界条件测试（层级超过10级、部门名称过长）
  - [ ] 性能测试（大量部门数据查询）
  - [ ] 异常处理测试（数据库异常、并发操作）
- [ ] 执行测试并验证结果 ⏳ 待开发
- [ ] 生成测试覆盖率报告 ⏳ 待开发
- [ ] 集成到CI/CD流程 ⏳ 待开发
- [ ] 创建开发文档 ⏳ 待开发

#### 4.2 前端功能测试
- [ ] 部门管理页面功能测试 ⏳ 待Playwright测试
  - 部门树形结构展示测试 ⏳ 待测试
  - 部门CRUD功能测试 ⏳ 待测试
  - 部门负责人设置测试 ⏳ 待测试
  - 部门移动功能测试 ⏳ 待测试
  - 部门状态切换测试 ⏳ 待测试
- [ ] 部门树形组件测试 ⏳ 待Playwright测试
  - 树形结构展示测试 ⏳ 待测试
  - 节点展开/折叠测试 ⏳ 待测试
  - 节点拖拽测试 ⏳ 待测试
  - 右键菜单测试 ⏳ 待测试
- [ ] 用户管理页面部门功能测试 ⏳ 待开发
  - 部门选择测试 ⏳ 待开发
  - 按部门筛选测试 ⏳ 待开发
- [ ] 创建开发文档 ⏳ 待开发

#### 4.3 前后端联调测试
- [ ] 部门管理完整流程测试 ⏳ 待Playwright测试
  - 创建部门 → 编辑部门 → 删除部门 ⏳ 待测试
  - 创建多级部门 → 查看树形结构 → 移动部门 ⏳ 待测试
  - 设置部门负责人 → 查看部门用户 ⏳ 待测试
- [ ] 用户与部门关联测试 ⏳ 待开发
  - 创建用户时选择部门 ⏳ 待开发
  - 编辑用户时修改部门 ⏳ 待开发
  - 按部门筛选用户 ⏳ 待开发
  - 删除部门时处理用户关联 ⏳ 待开发
- [ ] 权限验证测试 ⏳ 待测试
  - 部门管理权限控制测试 ⏳ 待测试
  - 部门查询权限控制测试 ⏳ 待测试
- [ ] 异常处理测试 ⏳ 待测试
  - 部门编码重复测试 ⏳ 待测试
  - 部门层级异常测试 ⏳ 待测试
  - 部门删除限制测试 ⏳ 待测试
- [ ] 创建开发文档 ⏳ 待开发

## 验收标准
- [x] 部门能正常创建、编辑、删除
- [x] 部门树形结构能正确展示
- [x] 部门层级管理功能正常
- [x] 部门负责人能正常设置和移除
- [x] 部门能正常移动（调整层级）
- [ ] 用户能正确关联到部门 ⏳ 待开发
- [ ] 删除部门时能正确处理用户关联 ⏳ 待完善
- [x] 所有接口都有相应权限控制
- [ ] 前后端联调测试通过 ⏳ 待测试
- [ ] 单元测试覆盖率 > 80% ⏳ 待测试
- [x] API文档完整正确

## 技术要点
- 树形结构递归查询和构建
- 部门层级自动计算
- 部门拖拽移动功能
- Element Plus Tree组件使用
- 部门与用户关联管理
- 部门负责人管理
- 部门状态管理
- MyBatis-Plus递归查询
- Vue 3 Composition API
- TypeScript类型安全

## 注意事项
- 部门编码必须唯一
- 部门层级不能超过10级
- 不能将部门设置为自己的子部门
- 删除部门前必须检查是否有子部门和关联用户
- 部门树形结构查询需要优化性能（避免N+1查询）
- 前端树形组件需要处理大量数据（虚拟滚动）
- 部门移动需要更新所有子部门的层级
- 数据库字段长度要合理设置
- 接口要做好参数验证和错误处理

## 预计完成时间
18:00 - 部门管理模块开发完成并测试通过

## 风险评估
- 部门树形结构查询性能问题
- 部门层级计算逻辑复杂
- 部门移动操作影响范围大
- 前端树形组件大数据量渲染问题
- 部门与用户关联关系复杂
- 并发操作可能导致数据不一致

## 依赖检查
- 确保用户管理模块已完成
- 确保数据库表结构与实体类匹配
- 确保前端Element Plus Tree组件正确配置
- 确保部门权限已在权限系统中配置
- 确保部门与用户关联关系正确

## 开发流程规范

### 一、开发模式与流程
1. **采用持续集成（CI）开发模式**，确保代码持续集成、自动化构建与测试。
2. **功能驱动开发**：每个功能模块开发完成后，必须经过充分测试与验证，确保无误后方可进入下一功能开发。
3. **迭代推进**：以功能为单位进行迭代，保证每个模块稳定可用。

### 二、测试策略
1. **本地测试优先**：
   - 所有功能需在本地进行完整测试，包括单元测试、集成测试及界面交互测试。
   - 需使用与CI环境一致的测试工具和依赖版本。
2. **自动化测试**：
   - 针对关键路径与核心功能编写自动化测试脚本。
   - 每次提交前应在本地运行自动化测试套件。
3. **推送前验证**：
   - 确保本地测试全部通过后，才可将代码推送至GitHub。
4. **部署测试**：
   - 代码推送后触发CI流程，执行部署与线上环境测试，确保功能在目标环境中正常运行。

### 三、版本控制与部署
1. **分支管理**：采用功能分支策略，每个新功能在独立分支开发，通过Pull Request合并至主分支。
2. **CI/CD流水线**：
   - 利用GitHub Actions等工具实现自动化测试与部署。
   - 部署成功后需在测试环境进行验证。
3. **回滚机制**：确保发现严重问题时能快速回退至上一稳定版本。

### 四、过程记录与文档
1. **开发记录**：每个功能需记录：
   - 实现思路、关键代码变更、依赖调整。
   - 开发过程中遇到的问题与解决方案。
2. **测试记录**：
   - 测试工具、框架及版本。
   - 测试方法、用例设计、测试数据。
   - 测试结果（通过/失败）、截图或日志摘要。
   - 发现的缺陷及其修复状态。
3. **文档更新**：
   - 同步更新技术文档、API文档及用户手册。
   - 记录配置变更、环境依赖及部署步骤。

### 五、质量与协作要求
1. **代码审查**：所有合并请求需经过至少一名成员审查。
2. **持续反馈**：定期同步开发与测试进展，及时调整计划。
3. **责任到人**：每个功能由开发者主导测试并确保质量，测试记录归档至项目Wiki或指定文档库。

通过以上规范，旨在形成**开发→测试→记录→集成**的闭环流程，确保交付质量，并为后续维护、BUG修复与优化提供完整依据。
