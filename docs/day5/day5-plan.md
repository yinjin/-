# 第五天工作计划：基础管理模块开发 - 耗材分类管理

## 日期：2026年1月9日

## 总体目标
完成耗材分类管理模块的开发，实现耗材分类的树形结构管理、分类编码自动生成、分类与耗材关联等功能，为耗材信息管理提供分类基础。

## 详细工作任务

### 1. 后端耗材分类管理模块开发（预计4小时）

#### 1.1 耗材分类实体类设计（预计1小时）
- [x] 创建耗材分类实体类 `MaterialCategory`
  - 分类基本信息字段：id、categoryName、categoryCode、parentId、level、sortOrder ✅
  - 分类状态字段：status（正常/禁用）、createTime、updateTime ✅
  - 分类描述字段：description（分类描述） ✅
  - 使用Lombok注解简化代码 ✅
  - 配置MyBatis-Plus注解和表映射 ✅
- [x] 创建耗材分类DTO类
  - `MaterialCategoryCreateDTO`：分类创建请求 ✅
  - `MaterialCategoryUpdateDTO`：分类更新请求 ✅
  - `MaterialCategoryVO`：分类信息响应 ✅
  - `MaterialCategoryTreeVO`：分类树形结构响应 ✅
- [x] 配置实体类验证注解
  - 分类名称长度验证 ✅
  - 分类编码唯一性验证 ✅
  - 父分类ID存在性验证 ✅
- [x] 创建CategoryStatus枚举类
  - 定义分类状态枚举 ✅
  - 提供状态转换方法 ✅
- [x] 编译测试通过 ✅
- [x] 创建开发教程文档

#### 1.2 耗材分类数据访问层（预计1小时）
- [x] 创建耗材分类Mapper接口 `MaterialCategoryMapper`
  - 继承BaseMapper获得基础CRUD方法 ✅
  - 自定义查询方法：根据分类编码查询、根据父分类ID查询子分类、分页查询 ✅
  - 查询分类树形结构方法（递归查询） ✅
  - 查询分类及其所有子分类方法 ✅
  - 配置MyBatis-Plus注解 ✅
- [x] 创建耗材分类Repository接口 `MaterialCategoryRepository`
  - 继承JpaRepository获得JPA方法 ✅
  - 自定义查询方法：根据分类名称查找、根据分类编码查找 ✅
- [x] 配置数据访问层异常处理
  - 分类不存在异常处理 ✅
  - 分类编码重复异常处理 ✅
  - 分类层级异常处理（不能将分类设置为自己的子分类） ✅
- [x] 编译测试通过 ✅
- [x] 创建开发教程文档

#### 1.3 耗材分类业务逻辑层（预计1.5小时）
- [x] 创建耗材分类Service接口 `IMaterialCategoryService`
  - 定义分类创建、更新、删除、查询等业务方法接口 ✅
  - 定义分类树形结构查询方法接口 ✅
  - 定义分类层级管理方法接口 ✅
- [x] 创建耗材分类Service实现类 `MaterialCategoryServiceImpl`
  - 分类创建逻辑（分类编码唯一性检查、父分类存在性检查、层级计算） ✅
  - 分类更新逻辑（字段验证、唯一性检查、层级更新） ✅
  - 分类删除逻辑（检查是否有子分类、检查是否有关联耗材） ✅
  - 分类树形结构查询逻辑（递归构建树形结构） ✅
  - 分类层级管理逻辑（移动分类、调整层级） ✅
  - 分类列表查询逻辑（分页、搜索、筛选） ✅
- [x] 分类编码自动生成逻辑
  - 根据分类层级自动生成分类编码 ✅
  - 支持自定义分类编码 ✅
  - 编码格式：一级分类（A01）、二级分类（A01-01）、三级分类（A01-01-01） ✅
- [x] 分类树形结构构建
  - 递归查询子分类 ✅
  - 构建树形结构数据 ✅
  - 支持懒加载子分类 ✅
- [x] 分类与耗材关联管理
  - 查询分类下的所有耗材 ✅
  - 查询耗材所属分类 ✅
  - 分类删除时处理耗材关联 ✅
- [x] 编译测试通过 ✅
- [x] 创建开发教程文档

#### 1.4 耗材分类控制层（预计0.5小时）
- [x] 创建耗材分类Controller `MaterialCategoryController`
  - 分类创建接口 `/api/category` ✅
  - 分类更新接口 `/api/category/{id}` ✅
  - 分类删除接口 `/api/category/{id}` ✅
  - 获取分类详情接口 `/api/category/{id}` ✅
  - 获取分类树形结构接口 `/api/category/tree` ✅
  - 获取分类列表接口 `/api/category/list` ✅
  - 移动分类接口 `/api/category/{id}/move` ✅
  - 批量删除接口 `/api/category/batch/delete` ✅
- [x] 配置接口权限注解
  - 分类查询接口：`category:query` ✅
  - 分类创建接口：`category:create` ✅
  - 分类更新接口：`category:update` ✅
  - 分类删除接口：`category:delete` ✅
- [x] 集成Swagger API文档 ✅
- [x] 参数验证和异常处理 ✅
- [x] 编译测试通过 ✅

### 2. 数据库表结构完善（预计1小时）

#### 2.1 耗材分类相关表结构
- [x] 检查并完善耗材分类表 `material_category`
  - 确认所有字段定义正确 ✅
  - 检查索引配置（category_code、parent_id、status） ✅
  - 验证外键约束（如果需要） ✅
- [x] 执行数据库脚本更新
  - 更新init.sql脚本 ✅
  - 执行数据库迁移 ✅
- [x] 创建初始化数据
  - 创建初始分类数据（硬件类、软件类、工具类、材料类） ✅
  - 创建分类树形结构示例数据 ✅
- [x] 创建开发文档

### 3. 前端耗材分类管理页面开发（预计3小时）

#### 3.1 耗材分类管理页面开发（预计1.5小时）
- [ ] 创建耗材分类管理页面 `CategoryManage.vue`
  - 分类树形结构展示（使用Element Plus Tree组件） ✅
  - 分类列表表格（支持分页） ✅
  - 搜索功能（按分类名称、编码搜索） ✅
  - 新增分类弹窗表单 ✅
  - 编辑分类弹窗表单 ✅
  - 删除分类确认对话框 ✅
  - 分类状态切换功能 ✅
  - 分类移动功能（拖拽或选择父分类） ✅
- [ ] 配置分类管理路由
  - 添加到路由配置中 ✅
  - 配置页面权限 ✅
- [ ] 实现分类管理API调用
  - 获取分类树形结构 ✅
  - 获取分类列表 ✅
  - 新增分类 ✅
  - 更新分类 ✅
  - 删除分类 ✅
  - 移动分类 ✅
- [ ] 创建开发文档

#### 3.2 耗材分类树形组件开发（预计1小时）
- [ ] 创建耗材分类树形组件 `CategoryTree.vue`
  - 树形结构展示 ✅
  - 节点展开/折叠 ✅
  - 节点选择功能 ✅
  - 节点拖拽功能（移动分类） ✅
  - 节点右键菜单（新增、编辑、删除、移动） ✅
  - 节点图标和状态标识 ✅
- [ ] 实现树形组件交互
  - 点击节点查看详情 ✅
  - 右键菜单操作 ✅
  - 拖拽移动分类 ✅
  - 懒加载子分类 ✅
- [ ] 创建开发文档

#### 3.3 耗材管理页面集成分类功能（预计0.5小时）
- [ ] 更新耗材管理页面（如果已创建）
  - 耗材列表添加分类列 ✅
  - 新增/编辑耗材时添加分类选择（树形下拉框） ✅
  - 按分类筛选耗材 ✅
- [ ] 实现分类选择组件
  - 创建分类树形选择组件 `CategorySelect.vue` ✅
  - 支持单选和多选 ✅
  - 支持搜索分类 ✅
- [ ] 创建开发文档

### 4. 性能优化（预计1小时）

#### 4.1 前端请求风暴问题分析与优化
- [x] 分析后端日志，识别前端请求风暴问题
  - 识别重复登录请求问题 ✅
  - 识别重复获取分类树请求问题 ✅
  - 分析数据库连接池压力问题 ✅
- [x] 实现登录页面防抖机制
  - 添加500ms防抖定时器 ✅
  - 配合loading状态控制 ✅
  - 防止重复提交 ✅
- [x] 实现耗材分类管理页面请求去重
  - 添加请求去重标志位 ✅
  - 防止同时发起多个相同请求 ✅
  - 减少不必要的数据库查询 ✅
- [x] 优化数据库连接池配置
  - 配置HikariCP连接池参数 ✅
  - 提高最大连接数到20 ✅
  - 优化连接生命周期管理 ✅
  - 添加连接测试和监控 ✅
- [x] 创建性能优化报告文档 ✅

#### 4.2 功能测试和联调（预计1小时）

##### 4.2.1 后端接口测试
- [x] 创建测试类MaterialCategoryControllerTest
- [x] 创建测试环境配置application-test.yml
- [x] 配置H2内存数据库
- [x] 编写测试用例
  - [x] 分类创建接口测试（正常创建、编码重复、父分类不存在）
  - [x] 分类更新接口测试（正常更新、分类不存在、编码重复）
  - [x] 分类删除接口测试（正常删除、有子分类、有关联耗材）
  - [x] 分类树形结构查询测试（树形结构正确、层级正确）
  - [x] 分类移动测试（正常移动、移动到子分类、移动到自己）
  - [x] 批量删除测试（正常删除、部分失败）
  - [x] 边界条件测试（层级超过10级、分类名称过长）
  - [x] 性能测试（大量分类数据查询）
  - [x] 异常处理测试（数据库异常、并发操作）
- [x] 执行测试并验证结果
- [x] 生成测试覆盖率报告
- [x] 集成到CI/CD流程
- [x] 创建开发文档

#### 4.2 前端功能测试
- [ ] 耗材分类管理页面功能测试
  - 分类树形结构展示测试 ✅
  - 分类CRUD功能测试 ✅
  - 分类移动功能测试 ✅
  - 分类状态切换测试 ✅
- [ ] 耗材分类树形组件测试
  - 树形结构展示测试 ✅
  - 节点展开/折叠测试 ✅
  - 节点拖拽测试 ✅
  - 右键菜单测试 ✅
- [ ] 耗材管理页面分类功能测试
  - 分类选择测试 ✅
  - 按分类筛选测试 ✅
- [ ] 创建开发文档

#### 4.3 前后端联调测试
- [ ] 耗材分类管理完整流程测试
  - 创建分类 → 编辑分类 → 删除分类 ✅
  - 创建多级分类 → 查看树形结构 → 移动分类 ✅
- [ ] 耗材与分类关联测试
  - 创建耗材时选择分类 ✅
  - 编辑耗材时修改分类 ✅
  - 按分类筛选耗材 ✅
  - 删除分类时处理耗材关联 ✅
- [ ] 权限验证测试
  - 分类管理权限控制测试 ✅
  - 分类查询权限控制测试 ✅
- [ ] 异常处理测试
  - 分类编码重复测试 ✅
  - 分类层级异常测试 ✅
  - 分类删除限制测试 ✅
- [ ] 创建开发文档

## 验收标准
- [x] 耗材分类能正常创建、编辑、删除
- [x] 耗材分类树形结构能正确展示
- [x] 分类层级管理功能正常
- [x] 分类编码能自动生成
- [x] 分类能正常移动（调整层级）
- [x] 耗材能正确关联到分类
- [x] 删除分类时能正确处理耗材关联
- [x] 所有接口都有相应权限控制
- [ ] 前后端联调测试通过
- [ ] 单元测试覆盖率 > 80%
- [x] API文档完整正确

## 技术要点
- 树形结构递归查询和构建
- 分类编码自动生成
- 分类层级自动计算
- 分类拖拽移动功能
- Element Plus Tree组件使用
- 分类与耗材关联管理
- 分类状态管理
- MyBatis-Plus递归查询
- Vue 3 Composition API
- TypeScript类型安全

## 注意事项
- 分类编码必须唯一
- 分类层级不能超过10级
- 不能将分类设置为自己的子分类
- 删除分类前必须检查是否有子分类和关联耗材
- 分类树形结构查询需要优化性能（避免N+1查询）
- 前端树形组件需要处理大量数据（虚拟滚动）
- 分类移动需要更新所有子分类的层级
- 数据库字段长度要合理设置
- 接口要做好参数验证和错误处理

## 预计完成时间
18:00 - 耗材分类管理模块开发完成并测试通过

## 风险评估
- 分类树形结构查询性能问题
- 分类层级计算逻辑复杂
- 分类移动操作影响范围大
- 前端树形组件大数据量渲染问题
- 分类与耗材关联关系复杂
- 并发操作可能导致数据不一致

## 依赖检查
- 确保基础管理模块已完成
- 确保数据库表结构与实体类匹配
- 确保前端Element Plus Tree组件正确配置
- 确保分类权限已在权限系统中配置
- 确保分类与耗材关联关系正确

## 开发流程规范

### 一、开发模式与流程
1. **采用持续集成（CI）开发模式**，确保代码持续集成、自动化构建与测试。
2. **功能驱动开发**：每个功能模块开发完成后，必须经过充分测试与验证，确保无误后方可进入下一功能开发。
3. **迭代推进**：以功能为单位进行迭代，保证每个模块稳定可用。

### 二、测试策略
1. **本地测试优先**：
   - 所有功能需在本地进行完整测试，包括单元测试、集成测试及界面交互测试。
   - 需使用与CI环境一致的测试工具和依赖版本。
2. **自动化测试**：
   - 针对关键路径与核心功能编写自动化测试脚本。
   - 每次提交前应在本地运行自动化测试套件。
3. **推送前验证**：
   - 确保本地测试全部通过后，才可将代码推送至GitHub。
4. **部署测试**：
   - 代码推送后触发CI流程，执行部署与线上环境测试，确保功能在目标环境中正常运行。

### 三、版本控制与部署
1. **分支管理**：采用功能分支策略，每个新功能在独立分支开发，通过Pull Request合并至主分支。
2. **CI/CD流水线**：
   - 利用GitHub Actions等工具实现自动化测试与部署。
   - 部署成功后需在测试环境进行验证。
3. **回滚机制**：确保发现严重问题时能快速回退至上一稳定版本。

### 四、过程记录与文档
1. **开发记录**：每个功能需记录：
   - 实现思路、关键代码变更、依赖调整。
   - 开发过程中遇到的问题与解决方案。
2. **测试记录**：
   - 测试工具、框架及版本。
   - 测试方法、用例设计、测试数据。
   - 测试结果（通过/失败）、截图或日志摘要。
   - 发现的缺陷及其修复状态。
3. **文档更新**：
   - 同步更新技术文档、API文档及用户手册。
   - 记录配置变更、环境依赖及部署步骤。

### 五、质量与协作要求
1. **代码审查**：所有合并请求需经过至少一名成员审查。
2. **持续反馈**：定期同步开发与测试进展，及时调整计划。
3. **责任到人**：每个功能由开发者主导测试并确保质量，测试记录归档至项目Wiki或指定文档库。

通过以上规范，旨在形成**开发→测试→记录→集成**的闭环流程，确保交付质量，并为后续维护、BUG修复与优化提供完整依据。
